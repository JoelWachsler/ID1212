{"version":3,"sources":["../../src/game/game.js"],"names":["Game","constructor","controller","snakes","food","gameArea","gameAreaWidth","gameAreaHeight","createGameArea","fps","setInterval","updateSnakes","bind","length","spawnFood","i","push","randomPoint","minX","maxX","minY","maxY","x","Math","floor","random","y","maxFoodToSpawn","newFood","isCollidingWithPoints","map","point","snakePoints","snake","body","snakePointsArray","concat","apply","updateFood","updateGameArea","networkController","pushGameArea","pushFood","foodLen","forEach","applyMovement","colliding","isCollidingWithFood","filter","slice","pushGameOver","id","match","j","cmpSnake","splice","pushSnakes","updateMovement","newDirection","find","changeMovement","addPlayer","okSpawn","spawnPoint","isColliding","removePlayer","index","findIndex"],"mappings":"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","file":"game.js","sourcesContent":["// @ts-check\nimport Snake from \"./snake\";\nimport Point from \"./point\";\nimport Food from \"./food\";\nimport { SIZE } from \"../common/constants\";\nimport Controller from \"../controller/controller\";\n\n/**\n * Keeps track of a game room instance.\n */\nexport default class Game {\n  /**\n   * @param {Controller} controller \n   * @api public\n   */\n  constructor(controller) {\n    this.controller = controller;\n    this.snakes = [];\n    this.food = [];\n    this.gameArea = [];\n\n    // Define the game area.\n    this.gameAreaWidth = 1000;\n    this.gameAreaHeight = 1000;\n\n    this.createGameArea();\n\n    // Rate of which to update the game\n    this.fps = 10;\n\n    // Server fps\n    setInterval(this.updateSnakes.bind(this), 1000 / this.fps);\n\n    // Let's spawn some random food if there's less than 100 on the board.\n    // Check every 5 seconds.\n    setInterval(() => {\n      if (this.food.length < 1000) this.spawnFood(100);\n    }, 1000);\n\n    // Initial spawn\n    this.spawnFood();\n  }\n\n  /**\n   * Creates points for the game area.\n   * \n   * @api private\n   */\n  createGameArea() {\n    // Let's create the game area\n    for (let i = -this.gameAreaWidth; i <= this.gameAreaHeight; i += 25) {\n      // Top\n      this.gameArea.push(new Point(i, -this.gameAreaHeight));\n      // Right\n      this.gameArea.push(new Point(this.gameAreaWidth, i));\n      // Bottom\n      this.gameArea.push(new Point(i, this.gameAreaHeight));\n      // Left\n      this.gameArea.push(new Point(-this.gameAreaWidth, i));\n    }\n  }\n\n  /**\n   * Generates a random point depending on the input.\n   * \n   * @param {number} minX \n   * @param {number} maxX \n   * @param {number} minY \n   * @param {number} maxY \n   * @return {Point} point\n   * @api private\n   */\n  randomPoint(minX=-this.gameAreaWidth+25,\n              maxX=this.gameAreaWidth-25,\n              minY=-this.gameAreaHeight+25,\n              maxY=this.gameAreaHeight-25) {\n\n    let x = Math.floor(Math.random() * (maxX - minX) + minX);\n    let y = Math.floor(Math.random() * (maxY - minY) + minY);\n\n    // Only multiples of 25.\n    x -= x % SIZE;\n    y -= y % SIZE;\n\n    return new Point(x, y);\n  }\n\n  /**\n   * @api private\n   */\n  spawnFood(maxFoodToSpawn) {\n    // Spawn some random food\n    // 200 attempts\n    for (let i = 0; i < maxFoodToSpawn; i++) {\n      const newFood = new Food(this.randomPoint());\n\n      // Do not spawn food on another piece of food.\n      if (newFood.isCollidingWithPoints(this.food.map(food => food.point))) continue;\n\n      // Do not spawn food on a snake.\n      const snakePoints = this.snakes.map(snake => snake.body);\n      const snakePointsArray = [].concat.apply([], snakePoints);\n      if (newFood.isCollidingWithPoints(snakePointsArray)) continue;\n\n      this.food.push(newFood);\n    }\n\n    // Push the changes to all clients.\n    this.updateFood();\n  }\n\n  /**\n   * @api private\n   */\n  updateGameArea() {\n    this.controller.networkController.pushGameArea(this.gameArea);\n  }\n\n  /**\n   * @api private\n   */\n  updateFood() {\n    this.controller.networkController.pushFood(this.food);\n  }\n\n  /**\n   * Updates the game state for all players.\n   * \n   * @api private\n   */\n  updateSnakes() {\n    const foodLen = this.food.length;\n\n    // Move all players\n    this.snakes.forEach(snake => snake.applyMovement());\n\n    // Check if this player is colliding with a piece of food.\n    this.snakes.forEach(snake => {\n      const colliding = snake.isCollidingWithFood(this.food);\n\n      if (!colliding) return;\n    });\n\n    // Check if a snake is eating itself.\n    this.snakes = this.snakes.filter(snake => {\n      const colliding = snake.isCollidingWithPoints(snake.body.slice(1));\n      \n      if (colliding) this.controller.networkController.pushGameOver(snake.id, \"ate yourself!\");\n\n      return !colliding;\n    });\n\n    // Check if a snake is colliding a wall.\n    this.snakes = this.snakes.filter(snake => {\n      const colliding = snake.isCollidingWithPoints(this.gameArea);\n      \n      if (colliding) this.controller.networkController.pushGameOver(snake.id, \"crashed into a wall!\");\n\n      return !colliding;\n    });\n\n    // Check if a snake is crashing into another snake.\n    // Going from the back so we don't mess anything up if a snake is removed.\n    for (let i = this.snakes.length - 1; i >= 0; i--) {\n      const snake = this.snakes[i];\n      let match = false;\n      for (let j = 0; j < this.snakes.length && !match; j++) {\n        if (i === j) continue;\n\n        const cmpSnake = this.snakes[j].body;\n\n        if (snake.isCollidingWithPoints(cmpSnake)) {\n          match = true;\n          this.controller.networkController.pushGameOver(snake.id, \"crashed into another snake!\");\n        }\n      }\n\n      // Removing the snake who collided.\n      if (match) this.snakes.splice(i, 1);\n    }\n\n    // Only update the food if something happened to them\n    if (this.food.length != foodLen) this.updateFood();\n\n    // Broadcast them\n    this.controller.networkController.pushSnakes(this.snakes);\n  }\n\n  /**\n   * @param {string} id \n   * @param {number} newDirection \n   * @api private\n   */\n  updateMovement(id, newDirection) {\n    const snake = this.snakes.find(snake => snake.id === id);\n\n    if (snake !== void 0) snake.changeMovement(newDirection);\n  }\n\n  /**\n   * Adds a player to the current game instance.\n   *\n   * @param {string} id\n   * @api public\n   */\n  addPlayer(id) {\n    // Check if the player is already playing.\n    if (this.snakes.find(snake => snake.id === id) !== void 0) return;\n\n    // Spawn a new snake on a free point.\n    let okSpawn = false;\n    while (!okSpawn) {\n      const spawnPoint = this.randomPoint(\n        -this.gameAreaWidth+25,\n        this.gameAreaWidth-500,\n        -this.gameAreaHeight+25,\n        this.gameAreaHeight-25);\n      okSpawn = true;\n\n      for (let i = 0; i < this.snakes.length; i++) {\n        if (this.snakes[i].isColliding(spawnPoint)) {\n          okSpawn = false;\n          break;\n        }\n      }\n\n      if (okSpawn) this.snakes.push(new Snake(id, spawnPoint));\n    }\n  }\n\n  /**\n   * Removes the player with the provided id from the list of players in this game.\n   *\n   * @param {string} id\n   * @api public\n   */\n  removePlayer(id) {\n    const index = this.snakes.findIndex(snake => snake.id === id);\n\n    if (index === -1) return;\n\n    this.snakes.splice(index, 1);\n  }\n}\n"]}